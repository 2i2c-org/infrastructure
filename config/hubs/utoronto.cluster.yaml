name: utoronto
provider: kubeconfig
kubeconfig:
  file: secrets/utoronto.yaml
support:
  config:
    prometheus:
      server:
        resources:
          requests:
            cpu: 0.5
            memory: 4Gi
          limits:
            cpu: 2
            memory: 16Gi
    grafana:
      ingress:
        hosts:
          - grafana.utoronto.2i2c.cloud
        tls:
          - secretName: grafana-tls
            hosts:
              - grafana.utoronto.2i2c.cloud
hubs:
  - name: staging
    domain: staging.utoronto.2i2c.cloud
    template: basehub
    auth0:
      enabled: false
    config:
      nfs: &staging_nfs
        enabled: true
        pv:
          # Recommended options from the Azure Portal UI for mounting the share
          mountOptions:
            - vers=4
            - minorversion=1
            - sec=sys
          serverIP: 2i2cutorontohubstorage.file.core.windows.net
          # Trailing slash is important!
          baseShareName: /2i2cutorontohubstorage/homes/
      jupyterhub:
        custom: &staging_jhub_custom
          homepage:
            templateVars:
              org:
                name: University of Toronto
                logo_url: https://raw.githubusercontent.com/utoronto-2i2c/homepage/master/extra-assets/images/home-hero.png
                url: https://www.utoronto.ca/
              designed_by:
                name: 2i2c
                url: https://2i2c.org
              operated_by:
                name: 2i2c
                url: https://2i2c.org
              funded_by:
                name: University of Toronto
                url: https://www.utoronto.ca/
        singleuser: &staging_jhub_singleuser
          initContainers:
            # Need to explicitly fix ownership here, since Azure File doesn't do anonuid
            - name: volume-mount-ownership-fix
              image: busybox
              command:
                [
                  "sh",
                  "-c",
                  "id && chown 1000:1000 /home/jovyan && ls -lhd /home/jovyan",
                ]
              securityContext:
                runAsUser: 0
              volumeMounts:
                - name: home
                  mountPath: /home/jovyan
                  subPath: "{username}"
          image:
            name: quay.io/2i2c/utoronto-image
            tag: 83a724f5b829
        hub:
          db:
            pvc:
              # Default seems too slow for our database, causes very bad response times
              storageClassName: managed-premium
          readinessProbe: &staging_jhub_redinessProbe
            enabled: false
          config:
            Authenticator: &staging_jhub_authenticator
              enable_auth_state: false
              admin_users:
                - 7c76d04b-2a80-4db1-b985-a2d2fa2f708c
                - 09056164-42f5-4113-9fd7-dd852e63ff1d
                - adb7ebad-9fb8-481a-bc2c-6c0a8b6de670
            JupyterHub: &staging_jhub_jupyterhub
              authenticator_class: azuread
              concurrent_spawn_limit: 100
              # We wanna keep logs long term, primarily for analytics
              extra_log_file: /srv/jupyterhub/jupyterhub.log
            AzureAdOAuthenticator:
              username_claim: oid
              login_service: "University of Toronto ID"
              oauth_callback_url: https://staging.utoronto.2i2c.cloud/hub/oauth_callback
              tenant_id: 78aac226-2f03-4b4d-9037-b46d56c55210
  - name: prod
    domain: jupyter.utoronto.ca
    template: basehub
    auth0:
      enabled: false
    config:
      nfs: *staging_nfs
      jupyterhub:
        custom: *staging_jhub_custom
        singleuser: *staging_jhub_singleuser
        hub:
          db:
            pvc:
              # Default seems too slow for our database, causes very bad response times
              storageClassName: managed-premium
              # prod also stores logs, so let's make it big
              storage: 10Gi
          readinessProbe: *staging_jhub_redinessProbe
          config:
            Authenticator: *staging_jhub_authenticator
            JupyterHub: *staging_jhub_jupyterhub
            AzureAdOAuthenticator:
              username_claim: oid
              login_service: "University of Toronto ID"
              oauth_callback_url: https://utoronto.2i2c.cloud/hub/oauth_callback
              tenant_id: 78aac226-2f03-4b4d-9037-b46d56c55210
