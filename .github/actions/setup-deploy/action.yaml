# This is a _local composite GitHub action_ that helps us reuse CI logic across
# different workflows and jobs by referencing this action in a job's step.
#
# > A composite action allows you to combine multiple workflow steps within one
# > action.
#
# This local action can be referenced like this from a job:
#
#   steps:
#     - uses: ./.github/actions/setup-deploy
#       with:
#         provider: gcp
#         GCP_KMS_DECRYPTOR_KEY: ${{ secrets.GCP_KMS_DECRYPTOR_KEY }}
#
# General action configuration reference:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#about-yaml-syntax-for-github-actions
#
name: "Setup the deployer script for use to deploy"
description: >-
  Setups the deployer script by loading credentials and installing relevant tools
  needed to interact with encrypted files, kubernetes clusters, and container
  registries.

# inputs configuration reference:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#inputs
#
inputs:
  provider:
    description: "Cloud provider a cluster runs on"
    required: true
    default: "gcp"
  GCP_KMS_DECRYPTOR_KEY:
    description: >-
      A Google Cloud Service Account Key with KMS Decryption privileges. This allows
      us to unlock our sops-encrypted secrets required for a deploy.
    required: true

# runs (for composite actions) configuration reference:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#runs-for-composite-actions
#
# Note that while this section looks almost like the steps of a job in a
# workflow, it is different!
#
runs:
  using: "composite"
  steps:
    - name: Setup credentials for sops to decrypt files with Google Cloud KMS
      uses: google-github-actions/auth@v0
      with:
        credentials_json: "${{ inputs.GCP_KMS_DECRYPTOR_KEY }}"

    - name: Install gcloud
      uses: google-github-actions/setup-gcloud@v0

    - name: Setup helm
      uses: azure/setup-helm@v2.0

    - name: Setup sops
      uses: mdgreenwald/mozilla-sops-action@v1
      with:
        version: v3.7.2

    - name: Setup kops
      if: inputs.provider == 'aws'
      run: |
        curl -Lo /tmp/kops https://github.com/kubernetes/kops/releases/download/$KOPS_VERSION/kops-linux-amd64
        chmod +x /tmp/kops
        sudo mv /tmp/kops /usr/local/bin/kops
      env:
        KOPS_VERSION: "v1.21.1"
      shell: bash

    - name: Setup Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: "3.9"

    - name: Setup deployer script Python dependencies
      run: |
        python -m pip install -r requirements.txt
      shell: bash
