name: Deploy and test hubs

on:
  push:
    branches:
      - master
    paths:
      - deployer/**
      - requirements.txt
      - .github/workflows/deploy-hubs.yaml
      - .github/actions/setup-deploy/**
      - "**.yaml"
    tags:
      - "**"
  pull_request:
    branches:
      - master
    paths:
      - deployer/**
      - requirements.txt
      - .github/workflows/deploy-hubs.yaml
      - .github/actions/setup-deploy/**
      - "**.yaml"
  workflow_dispatch:

# When multiple PRs triggering this workflow are merged, queue them instead
# of running them in parallel
# https://github.blog/changelog/2021-04-19-github-actions-limit-workflow-run-or-job-concurrency/
concurrency: deploy

jobs:
  generate-jobs:
    runs-on: ubuntu-latest
    outputs:
      support-and-staging-matrix-jobs: ${{ steps.generated-jobs.outputs.support-and-staging-matrix-jobs }}
      prob-hub-matrix-jobs: ${{ steps.generated-jobs.outputs.prod-hub-matrix-jobs }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Identify files that have been added or modified
        uses: jitterbit/get-changed-files@v1
        id: changed-files
        with:
          format: space-delimited
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate matrix jobs
        if: github.event_name != 'pull_request'
        run: |
          python deployer generate-helm-upgrade-jobs "${{ steps.changed-files.outputs.added_modified }}"

      - name: Pretty print matrix jobs
        if: github.event_name != 'pull_request'
        run: |
          python deployer generate-helm-upgrade-jobs --pretty-print "${{ steps.changed-files.outputs.added_modified }}"

  deploy:
    runs-on: ubuntu-latest
    strategy:
      # Don't stop other deployments if one fails
      fail-fast: false
      matrix:
        include:
          # To enable auto-deployments for other clusters,
          # add its name and provider to the list
          - cluster_name: 2i2c
            provider: gcp
          - cluster_name: cloudbank
            provider: gcp
          - cluster_name: carbonplan
            provider: aws
          - cluster_name: farallon
            provider: aws
          - cluster_name: openscapes
            provider: aws
          - cluster_name: uwhackweeks
            provider: aws
          - cluster_name: meom-ige
            provider: gcp
          - cluster_name: pangeo-hubs
            provider: gcp
          - cluster_name: leap
            provider: gcp
          - cluster_name: utoronto
            provider: kubeconfig
          - cluster_name: azure.carbonplan
            provider: kubeconfig

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Check if any of our base files have changed
        uses: dorny/paths-filter@v2
        id: base_files
        with:
          filters: |
            files:
              - "deployer/**"
              - "helm-charts/**"
              - "requirements.txt"
              - "config/secrets.yaml"
              - ".github/workflows/deploy-hubs.yaml"
              - ".github/actions/deploy/*"

      - name: Check which cluster directory has changes (if any)
        uses: dorny/paths-filter@v2
        id: config_files
        with:
          filters: |
            hub_config:
              - "config/clusters/${{ matrix.cluster_name }}/**"

      - name: Deploy ${{ matrix.cluster_name }}
        if: |
          (steps.base_files.outputs.files == 'true') ||
          (steps.config_files.outputs.hub_config == 'true')
        uses: ./.github/actions/deploy
        with:
          provider: ${{ matrix.provider }}
          cluster: ${{ matrix.cluster_name }}
        env:
          TERM: xterm
