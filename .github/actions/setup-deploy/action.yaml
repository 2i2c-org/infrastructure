# This is a _local composite GitHub action_ that helps us reuse CI logic across
# different workflows and jobs by referencing this action in a job's step.
#
# > A composite action allows you to combine multiple workflow steps within one
# > action.
#
# This local action can be referenced like this from a job:
#
#   steps:
#     - uses: ./.github/actions/setup-deploy
#       with:
#         provider: gcp
#         GCP_KMS_DECRYPTOR_KEY: ${{ secrets.GCP_KMS_DECRYPTOR_KEY }}
#
# General action configuration reference:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#about-yaml-syntax-for-github-actions
#
name: "Setup the deployer script for use to deploy"
description: >-
  Setups the deployer script by loading credentials and installing library
  dependencies and relevant tools needed to interact with encrypted files,
  kubernetes clusters, and container registries. Tools already available in the
  github virtual environments are not re-installed (gcloud, helm).

# inputs configuration reference:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#inputs
#
inputs:
  provider:
    description: "Cloud provider a cluster runs on"
    required: true
    default: "gcp"
  GCP_KMS_DECRYPTOR_KEY:
    description: >-
      A Google Cloud Service Account Key with KMS Decryption privileges. This allows
      us to unlock our sops-encrypted secrets required for a deploy.
    required: true

# runs (for composite actions) configuration reference:
# https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions#runs-for-composite-actions
#
# Note that while this section looks almost like the steps of a job in a
# workflow, it is different!
#
runs:
  using: "composite"
  steps:
    - uses: actions/setup-python@v3
      with:
        python-version: "3.9"

    - name: Attempt to restore cached Python dependencies
      uses: actions/cache@v3
      id: cache-pip
      with:
        path: ~/.cache/pip
        # key determines if we define or re-use an existing cache or not, and we
        # define a string composed of parts to ensure we only cache within a
        # workflow run attempt, not between workflow runs or separate attempts
        # of the runs.
        key: "${{ github.run_id }}-${{ github.run_attempt }}"

    - name: Install deployer script's Python dependencies
      if: steps.cache-pip.outputs.cache-hit != 'true'
      run: |
        pip install -r requirements.txt
        pip list
      shell: bash

    - name: Install kops
      if: inputs.provider == 'aws'
      run: |
        curl -Lo /tmp/kops https://github.com/kubernetes/kops/releases/download/$KOPS_VERSION/kops-linux-amd64
        chmod +x /tmp/kops
        sudo mv /tmp/kops /usr/local/bin/kops
      env:
        KOPS_VERSION: "v1.21.1"
      shell: bash

    - name: Install sops
      uses: mdgreenwald/mozilla-sops-action@v1
      with:
        version: v3.7.2

    - name: Setup sops credentials to decrypt repo secrets
      uses: google-github-actions/auth@v0
      with:
        credentials_json: "${{ inputs.GCP_KMS_DECRYPTOR_KEY }}"
