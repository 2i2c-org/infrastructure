name: pangeo-hubs
provider: gcp
gcp:
  key: secrets/pangeo-hubs.json
  project: pangeo-integration-te-3eea
  cluster: pangeo-hubs-cluster
  zone: us-central1-b
support:
  config:
    grafana:
      ingress:
        hosts:
          # This domain should be updated to just grafana.pangeo.2i2c.cloud
          # after the COESSING hub has been brought down and no longer requires
          # grafana.pangeo.2i2c.cloud
          - pangeo-grafana.pangeo.2i2c.cloud
        tls:
          - secretName: grafana-tls
            hosts:
              - pangeo-grafana.pangeo.2i2c.cloud
    # Disable the Admissions Validation Webhook and the port is not
    # permitted on private GKE clusters
    ingress-nginx:
      controller:
        admissionWebhooks:
          enabled: false
    nfs-server-provisioner:
      enabled: false
hubs:
  - name: staging
    domain: staging.pangeo.2i2c.cloud
    template: daskhub
    auth0:
      connection: github
    config: &stagingConfig
      basehub:
        nfs:
          enabled: true
          pv:
            mountOptions:
            - soft
            - noatime
            # Google FileStore IP
            serverIP: 10.229.44.234
            # Name of Google Filestore share
            baseShareName: /homes/
        jupyterhub:
          proxy:
            https:
              enabled: false
          custom:
            homepage:
              templateVars:
                org:
                  name: Pangeo
                  url: https://pangeo.io
                  logo_url: "https://raw.githubusercontent.com/pangeo-data/pangeo/master/docs/_static/pangeo_simple_logo.svg"
                designed_by:
                  name: 2i2c
                  url: https://2i2c.org
                operated_by:
                  name: 2i2c
                  url: https://2i2c.org
                funded_by:
                  name: The Gordon and Betty Moore Foundation
                  url: https://www.moore.org/
          hub:
            config:
              Authenticator:
                allowed_users: &staging_users
                  - sgibson91
                  - yuvipanda
                  - damianavila
                  - choldgraf
                  - rabernat
                admin_users: *staging_users
          singleuser:
            profileList:
              # The mem-guarantees are here so k8s doesn't schedule other pods
              # on these nodes. They need to be just under total allocatable
              # RAM on a node, not total node capacity
              - display_name: "Small"
                description: "~2 CPU, ~8G RAM"
                kubespawner_override:
                  mem_limit: 8G
                  mem_guarantee: 5.5G
                  node_selector:
                    node.kubernetes.io/instance-type: n1-standard-2
              - display_name: "Medium"
                description: "~8 CPU, ~32G RAM"
                kubespawner_override:
                  mem_limit: 32G
                  mem_guarantee: 25G
                  node_selector:
                    node.kubernetes.io/instance-type: n1-standard-8
              - display_name: "Large"
                description: "~16 CPU, ~64G RAM"
                kubespawner_override:
                  mem_limit: 64G
                  mem_guarantee: 55G
                  node_selector:
                    node.kubernetes.io/instance-type: n1-standard-16
              - display_name: "Very Large"
                description: "~32 CPU, ~128G RAM"
                kubespawner_override:
                  mem_limit: 128G
                  mem_guarantee: 115G
                  node_selector:
                    node.kubernetes.io/instance-type: n1-standard-32
            initContainers:
              # Need to explicitly fix ownership here, since EFS doesn't do anonuid
            - name: volume-mount-ownership-fix
              image: busybox
              command: ["sh", "-c", "id && chown 1000:1000 /home/jovyan && ls -lhd /home/jovyan"]
              securityContext:
                runAsUser: 0
              volumeMounts:
              - name: home
                mountPath: /home/jovyan
                subPath: "{username}"
            image:
              name: pangeo/pangeo-notebook
              tag: bcfacc5
            cpu:
              limit: 2
              guarantee: 1
            memory:
              limit: 4G
              guarantee: 2G
      dask-gateway:
        gateway:
          backend:
            scheduler:
              cores:
                request: 0.8
                limit: 1
              memory:
                request: 1G
                limit: 2G
