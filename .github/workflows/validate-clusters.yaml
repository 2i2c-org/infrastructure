# This is a GitHub workflow defining a set of jobs with a set of steps. ref:
# https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions
#
# Runs the deployer script to validate clusters. This will both validate
# cluster.yaml files, any non-encrypted values files for the support chart (if they
# exist), as well as each hubs passed non-encrypted values files against the Helm
# charts' values schema.
#
name: Validate clusters

on:
  pull_request:

jobs:
  validate-helm-charts-values-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install deployer script dependencies
        run: |
          pip install -r requirements.txt

      - name: "DEBUGGING: test misc details"
        if: steps.decision.outputs.continue-job == 'true'
        run: |
          helm repo list
          helm dep up helm-charts/basehub
          helm dep up helm-charts/daskhub --skip-refresh

      - name: "Validate cluster: ${{ matrix.cluster_name }}"
        if: steps.decision.outputs.continue-job == 'true'
        env:
          TERM: xterm
        run: |
          python deployer validate ${{ matrix.cluster_name }}
